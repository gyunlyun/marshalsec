name: Build Marshalsec

on:
  push:
    branches:
      - master  # 监控 master 分支的提交
    paths:
      - '**/*'  # 监控所有文件变更，也可以根据需要调整

  workflow_dispatch:
    inputs:
      release_title:
        description: 'Release title'
        required: true
        default: 'Marshalsec Release'
        type: string

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # 需要写入权限来创建 release
    
    steps:
    - name: Checkout Marshalsec repository
      uses: actions/checkout@v3
      with:
        repository: 'mbechler/marshalsec'  # 检出 mbechler/marshalsec 仓库
    
    - name: Get the latest commit SHA (first 7 characters)
      id: get_sha
      run: |
        COMMIT_SHA=$(git rev-parse --short=7 HEAD)  # 获取最新 commit 的前 7 位 SHA
        echo "commit_sha=$COMMIT_SHA" >> $GITHUB_ENV  # 保存 SHA 为环境变量
    
    - name: Set up JDK 8
      uses: actions/setup-java@v3
      with:
        java-version: '8.0.392+8'
        distribution: 'temurin'
        cache: maven
        
    - name: Build with Maven (Skip Tests)
      run: mvn -B clean package -DskipTests
        
    - name: List generated files
      run: ls -la target/
        
    - name: Create Release
      id: create_release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ env.commit_sha }}  # 使用从 mbechler/marshalsec 获取的前 7 位 commit SHA 作为版本标签
        name: Marshalsec Release ${{ env.commit_sha }}  # 使用前 7 位 commit SHA 作为发布名称
        draft: false
        prerelease: false
        files: |
          target/marshalsec-${{ env.commit_sha }}-all.jar  # 使用 commit SHA 作为文件名的一部分
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
